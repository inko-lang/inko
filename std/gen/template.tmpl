import std.bytes (Bytes)
import std.ptr

# The code in this module is generated using ./std/gen/hash.py and _must not_ be
# edited by hand. For more information, refer to ./std/gen/README.md.

let G = [$G]
let S1 = [$S1]
let S2 = [$S2]
let KEYS = [$K]

fn inline hash[B: Bytes](key: ref B) -> (Int, Int) {
  let mut i = 0
  let mut h1 = 0
  let mut h2 = 0

  while i < key.size {
    let s1 = S1.get_unchecked(i)
    let s2 = S2.get_unchecked(i)
    let k = ptr.add(key.pointer, i).0 as Int

    h1 = h1.wrapping_add(s1.wrapping_mul(k))
    h2 = h2.wrapping_add(s2.wrapping_mul(k))
    i += 1
  }

  (h1 % $NG, h2 % $NG)
}

# Returns the index of the given key.
#
# If the key is an unknown key, `-1` is returned.
fn inline index_of[B: Bytes](key: ref B) -> Int {
  if key.size > $NS { return -1 }

  let (k1, k2) = hash(key)
  let a = G.get_unchecked(k1)
  let b = G.get_unchecked(k2)
  let i = a.wrapping_add(b) % $NG

  match KEYS.get(i) {
    case Ok(v) if key.equals?(v) -> i
    case _ -> -1
  }
}
