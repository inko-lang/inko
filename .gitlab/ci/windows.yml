---
.only-source-repository:
  only:
    - branches@inko-lang/inko
    - tags@inko-lang/inko

test:compiler:windows:
  extends: .only-source-repository
  stage: test
  tags:
    - windows
  before_script:
    - cd compiler
    - ruby --version
    - gem --version
    - bundle --version
    - bundle install --path vendor --retry=3
  script:
    - C:/msys make test
  cache:
    key: windows
    paths:
      - compiler/vendor/ruby

test:ivm:windows:
  extends: .only-source-repository
  image: windows:1809
  stage: test
  tags:
    - windows
  before_script:
    - cd vm
    - rustc --version
    - cargo --version
  script:
    - C:/msys make test
  cache:
    key: windows
    paths:
      - .cargo
      - vm/target

test:runtime:windows:
  extends: .only-source-repository
  stage: test-runtime
  tags:
    - windows
  before_script:
    - ruby --version
    - rustc --version
    - cargo --version
  script:
    - C:/msys make -C vm release
    - ruby -I ./compiler/lib ./compiler/bin/inko-test -d runtime --vm ./vm/target/release/ivm.exe
  cache:
    key: windows
    paths:
      - .cargo
      - vm/target
  needs:
    - test:compiler:windows
    - test:ivm:windows

release:compiled:windows:
  extends: .only-source-repository
  stage: release
  tags:
    - windows
  before_script:
    - ruby --version
    - rustc --version
    - cargo --version
    - C:/msys aws --version
  script:
    - C:/msys make release-compiled
  only:
    - tags
  cache:
    key: windows
    paths:
      - .cargo
      - vm/target
  needs:
    - test:runtime:windows
